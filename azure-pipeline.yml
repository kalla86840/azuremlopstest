trigger:
  branches:
    include:
      - main

variables:
  AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
  AZURE_RESOURCE_GROUP: mlops test 1
  AZURE_WORKSPACE_NAME: mlops test 1
  AZURE_LOCATION: westus2

stages:
- stage: Dev
  displayName: "Train and Register Model"
  jobs:
  - job: TrainRegister
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.9'
    - script: |
        pip install -r requirements.txt
      workingDirectory: dev
      displayName: "Install Dev Requirements"
    - script: |
        python scripts/train.py
      workingDirectory: dev
      displayName: "Train Model"
    - script: |
        python scripts/register_model.py
      workingDirectory: dev
      displayName: "Register Model"

- stage: Prod
  displayName: "Deploy to Endpoint"
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - job: Deploy
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.9'
    - script: |
        pip install -r requirements.txt
      workingDirectory: prod
      displayName: "Install Prod Requirements"
    - script: |
        python scripts/deploy_endpoint.py
      workingDirectory: prod
      displayName: "Deploy to Azure ML ACI Endpoint"
